<!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAYcAA0AAAAACjQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABMAAAABwAAAAca8vGTk9TLzIAAAFMAAAARAAAAFZG1VHVY21hcAAAAZAAAAA+AAABQgAP9AdjdnQgAAAB0AAAAAQAAAAEACICiGdhc3AAAAHUAAAACAAAAAj//wADZ2x5ZgAAAdwAAADRAAABEKyikaNoZWFkAAACsAAAAC0AAAA2AtXoA2hoZWEAAALgAAAAHAAAACQHngNFaG10eAAAAvwAAAAQAAAAEAwAACJsb2NhAAADDAAAAAoAAAAKALIAVG1heHAAAAMYAAAAHwAAACABEAB2bmFtZQAAAzgAAALBAAAFu3I9x/Nwb3N0AAAF/AAAAB0AAAAvaoFvbwAAAAEAAAAAzBdyYwAAAADP2IQvAAAAAM/bz7t4nGNgZGFgnMDAysDB1Ml0hoGBoR9CM75mMGLkYGBgYmBlZsAKAtJcUxgcPsR8iGF2+O/AEMPsznAYKMwIkgMA5REMOXicY2BgYGaAYBkGRgYQsAHyGMF8FgYFIM0ChED+h5j//yEk/3KoSgZGNgYYk4GRCUgwMaACRoZhDwCs7QgGAAAAIgKIAAAAAf//AAJ4nHWMMQrCQBBF/0zWrCCIKUQsTDCL2EXMohYGSSmorScInsRGL2DOYJe0Ntp7BK+gJ1BxF1stZvjz/v8DRghQzEc4kIgKwiAppcA9LtzKLSkdNhKFY3HF4lK69ExKslx7Xa+vPRVS43G98vG1DnkDMIBUgFN0MDXflU8tbaZOUkXUH0+U27RoRpOIyCKjbMCVejwypzJJG4jIwb43rfl6wbwanocrJm9XFYfskuVC5K/TPyczNU7b84CXcbxks1Un6H6tLH9vf2LRnn8Ax7A5WQAAAHicY2BkYGAA4teL1+yI57f5ysDNwgAC529f0kOmWRiYVgEpDgYmEA8AUzEKsQAAAHicY2BkYGB2+O/AEMPCAAJAkpEBFbAAADgKAe0EAAAiAAAAAAQAAAAEAAAAAAAAKgAqACoAiAAAeJxjYGRgYGBhsGFgYgABEMkFhAwM/xn0QAIAD6YBhwB4nI1Ty07cMBS9QwKlQapQW3VXySvEqDCZGbGaHULiIQ1FKgjWMxknMfLEke2A+IJu+wntrt/QbVf9gG75jK577Lg8K1qQPCfnnnt8fX1NRC/pmjrk/zprC+8D7tBy9DHgBXoWfQ44Av8t4Bj4Z8CLtBL9CniJluPXASf0Lm4CXqFX8Q84dOLnMB17N4c7tBo1AS/Qi+hTwBH4rwHHwN8DXqQ30XXAS7QaLwSc0Gn8NuAVWou/gFmnjLrEaEh9GmDdDGgL3B4JsrRPDU2hTOiMSuJUIdKQQayiAth69r6akSSFqIJuA19TrzCIaY8sIoxyrNIrL//pw7A2iMygkX5vDj+G+kuoLdX4GlGK/8Lnlz6/h9MpmoO9rafrz7ILXEHHaAx95s9lsI7AHNMBWEZHULnfAXwG9/ZqdzLI08iuwRloXE8kfhXYAvE23+23DU3t626rbs8/8adv+9DWknsHp3E17oCf+Z48rvEQNZ78paYM38qfk3v/u3l3u3GXN2Dmvmvpf1Srwk3pB/VSsp512bA/GG5i2WJ7wu430yQ5K3nFGiOqgtmSB5pJVSizwaacmUZzZhXLlZTq8qGGFY2YcSkqbth6aW1tRmlaCFs2016m5qn36SbJrqosG4uMV4aP2PHBmB3tjtmgN2izkGQyLWprekbIntJFing32a5rKWCN/SdSoga45EJykyQ7asZvHQ8PTm6cslIpwyeyjbVltNikc2HTR7YKh9LBl9DADC0U/jLcBZDKrMhUBfQBvXRzLtFtjU9eNHKin0x5InTqb8lNpfKv1s1xHzTXRqgKzek/mb7nB8RZTCDhGEX3kK/8Q75AmUM/eLkfA+0Hi908Kx4eNsMgudg5GLdRD7a84npi+YxNr5i5KIbW5izXas7cHXIMAau1OueZhfj+cOcP3P8MNIWLyYOBuxL6DRylJ4cAAAB4nGNgYoAALjDJyIAOWMCiTIxMLDmZedkABtIBygAAAA==) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
  font-size: 0.85em;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .h {
  color: #333;
  font-style: normal;
  font-weight: normal;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs,
.markdown-body .highlight .cp .h {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb;
}

.markdown-body .highlight .pl-coc,
.markdown-body .highlight .pl-entm,
.markdown-body .highlight .pl-eoa,
.markdown-body .highlight .pl-mai .pl-sf,
.markdown-body .highlight .pl-pdv,
.markdown-body .highlight .pl-sc,
.markdown-body .highlight .pl-sr,
.markdown-body .highlight .pl-v,
.markdown-body .highlight .pl-vpf {
  color: #0086b3;
}

.markdown-body .highlight .pl-eoac,
.markdown-body .highlight .pl-mdht,
.markdown-body .highlight .pl-mi1,
.markdown-body .highlight .pl-mri,
.markdown-body .highlight .pl-va,
.markdown-body .highlight .pl-vpu {
  color: #008080;
}

.markdown-body .highlight .pl-c,
.markdown-body .highlight .pl-pdc {
  color: #b4b7b4;
  font-style: italic;
}

.markdown-body .highlight .pl-k,
.markdown-body .highlight .pl-ko,
.markdown-body .highlight .pl-kolp,
.markdown-body .highlight .pl-mc,
.markdown-body .highlight .pl-mr,
.markdown-body .highlight .pl-ms,
.markdown-body .highlight .pl-s,
.markdown-body .highlight .pl-sok,
.markdown-body .highlight .pl-st {
  color: #6e5494;
}

.markdown-body .highlight .pl-ef,
.markdown-body .highlight .pl-enf,
.markdown-body .highlight .pl-enm,
.markdown-body .highlight .pl-entc,
.markdown-body .highlight .pl-eoi,
.markdown-body .highlight .pl-sf,
.markdown-body .highlight .pl-smc {
  color: #d12089;
}

.markdown-body .highlight .pl-ens,
.markdown-body .highlight .pl-eoai,
.markdown-body .highlight .pl-kos,
.markdown-body .highlight .pl-mh .pl-pdh,
.markdown-body .highlight .pl-mp,
.markdown-body .highlight .pl-pde,
.markdown-body .highlight .pl-stp {
  color: #458;
}

.markdown-body .highlight .pl-enti {
  color: #d12089;
  font-weight: bold;
}

.markdown-body .highlight .pl-cce,
.markdown-body .highlight .pl-enc,
.markdown-body .highlight .pl-kou,
.markdown-body .highlight .pl-mq {
  color: #f93;
}

.markdown-body .highlight .pl-mp1 .pl-sf {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .pl-cos,
.markdown-body .highlight .pl-ent,
.markdown-body .highlight .pl-md,
.markdown-body .highlight .pl-mdhf,
.markdown-body .highlight .pl-ml,
.markdown-body .highlight .pl-pdc1,
.markdown-body .highlight .pl-pds,
.markdown-body .highlight .pl-s1,
.markdown-body .highlight .pl-scp,
.markdown-body .highlight .pl-sol {
  color: #df5000;
}

.markdown-body .highlight .pl-c1,
.markdown-body .highlight .pl-cn,
.markdown-body .highlight .pl-pse,
.markdown-body .highlight .pl-pse .pl-s2,
.markdown-body .highlight .pl-vi {
  color: #a31515;
}

.markdown-body .highlight .pl-mb,
.markdown-body .highlight .pl-pdb {
  color: #df5000;
  font-weight: bold;
}

.markdown-body .highlight .pl-mi,
.markdown-body .highlight .pl-pdi {
  color: #6e5494;
  font-style: italic;
}

.markdown-body .highlight .pl-ms1 {
  background-color: #f5f5f5;
}

.markdown-body .highlight .pl-mdh,
.markdown-body .highlight .pl-mdi {
  font-weight: bold;
}

.markdown-body .highlight .pl-mdr {
  color: #0086b3;
  font-weight: bold;
}

.markdown-body .highlight .pl-s2 {
  color: #333;
}

.markdown-body .highlight .pl-ii {
  background-color: #df5000;
  color: #fff;
}

.markdown-body .highlight .pl-ib {
  background-color: #f93;
}

.markdown-body .highlight .pl-id {
  background-color: #a31515;
  color: #fff;
}

.markdown-body .highlight .pl-iu {
  background-color: #b4b7b4;
}

.markdown-body .highlight .pl-mo {
  color: #969896;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}</style><title>kettle_tutorial</title></head><body><article class="markdown-body"><h1>
<a id="user-content-so-you-want-to-put-blackboard-data-in-a-learning-record-store" class="anchor" href="#so-you-want-to-put-blackboard-data-in-a-learning-record-store" aria-hidden="true"><span class="octicon octicon-link"></span></a>So You Want To Put Blackboard Data In A Learning Record Store</h1>

<h2>
<a id="user-content-preamble" class="anchor" href="#preamble" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preamble</h2>

<p>You're a developer in the unenviable position of delivering live learning data to researchers whose students use Blackboard. They don't know about database tables or cron jobs; they just know that their students are doing things online, they want to know the who, what, where, when and how, and they may or may not care about the ethical and legal implications of the whole process. If you're especially unlucky, you're also coming in at the tail end of a whole history of these data consumers being unsatisfied with previous efforts for one reason or another.</p>

<p>So, in an ideal world:</p>

<ol>
<li>you get a perfectly sensible list of requirements from your stakeholders</li>
<li>you know enough about the Blackboard database schema to see what table(s) to query to fulfill them</li>
<li>you're familiar enough with the Experience API specification to know that the data actually belongs in a Learning Record Store</li>
<li>you have systems in place to:

<ul>
<li>extract live Blackboard data</li>
<li>transform it into xAPI statements</li>
<li>load it into a live LRS</li>
</ul>
</li>
<li>you have infrastructure in place to do the above reliably and on the regular</li>
<li>you have informed consent from everyone whose data you're extracting

<ul>
<li>which actually means: you know whose data you're allowed to extract and whose you're not</li>
</ul>
</li>
</ol>

<p>Given the above, you can throw together a product, get it up and running in record time, and enjoy the warm fuzzies, total lack of appreciation, and additional unexpected demands that are the unavoidable consequences of a development job well done. (You're the hero the university needs right now, not the one it deserves.)</p>

<p>I'm betting you don't live in an ideal world, though. Hence: this guide.</p>

<h3>
<a id="user-content-what-this-guide-isnt-about" class="anchor" href="#what-this-guide-isnt-about" aria-hidden="true"><span class="octicon octicon-link"></span></a>What this guide isn't about</h3>

<p>The short answer: it isn't about points 1 or 6.</p>

<h3>
<a id="user-content-what-this-guide-might-be-a-little-bit-about" class="anchor" href="#what-this-guide-might-be-a-little-bit-about" aria-hidden="true"><span class="octicon octicon-link"></span></a>What this guide might be a little bit about</h3>

<p>Points 2, 3 and 5. I'm going to have to talk about these things in passing, but I'm going to assume you have at least cursory familiarity with:</p>

<ul>
<li>the xAPI spec (formerly Tin Can API) and the concept of an LRS, which implies some knowledge of

<ul>
<li>RESTful web design</li>
<li>JSON data</li>
</ul>
</li>
<li>the Blackboard schema, which implies

<ul>
<li>SQL (Oracle or MySQL, since those are the databases Blackboard supports; this guide was written in an environment that uses Oracle)</li>
</ul>
</li>
</ul>

<p>Also useful to have in the toolbox (but I strongly doubt I'll be saying anything you don't already know, even if you've never actually programmed in either language before):</p>

<ul>
<li>JavaScript</li>
<li>Java </li>
</ul>

<p>I'm also going to assume you have:</p>

<ul>
<li>a workable set of requirements</li>
<li>an environment you can develop in, which because you're communicating between various data sources also implies

<ul>
<li>credentials to query the Blackboard DB</li>
<li>credentials to GET from and POST to the LRS</li>
</ul>
</li>
<li>an environment you can deploy to</li>
<li>ethical permission to do so.</li>
</ul>

<p>I mention these at all because you're almost definitely a developer at a university, which means you're operating in an enterprisey context, and these things can be major headaches even <em>without</em> institutional roadblocks. If you don't have it in black and white that they're sorted out: godspeed.</p>

<h3>
<a id="user-content-what-this-guide-definitely-is-about" class="anchor" href="#what-this-guide-definitely-is-about" aria-hidden="true"><span class="octicon octicon-link"></span></a>What this guide definitely is about</h3>

<p>It's about point 4. Of the subset of the problem domain which can't be efficiently solved in hardware or wetware, the biggest problem is getting various systems to talk to each other intelligibly and intelligently. So much so that there's a whole class of tools designed to do just that: ETL tools (Extract, Transform, Load). I'll be showing you how to get the above job done using one such tool: <a href="http://community.pentaho.com/projects/data-integration/">Kettle</a> (the old and much pithier name for what's now called Pentaho Data Integration). Check the above link if you want the sales pitch; here's what's important:</p>

<ul>
<li>It's written in Java, so it's very portable; this is the reason why so much of the above is system-agnostic. (For what it's worth, the solutions I've delivered have been developed on Windows and deployed on Linux.)</li>
<li>It amounts to a visual programming language; I was initially sceptical about developing with something that claims not to require any prior programming knowledge, but don't worry, that's pure Madison Avenue-caliber bullshit.</li>
<li>The end results (consisting of pretty little GUI flowcharts showing you where your data is coming from, what's happening to it, and where it's going) are actually just XML files, so not only is the tool highly interoperable, your work is too. This is a Good Thing: if you're trying even medium-hard to stick to the spirit of the xAPI spec, then the chances that nobody else will ever use a similar transform are slim to none, and you want to reduce their overhead as much as possible.</li>
<li>It's open-source. This is a mixed bag: it means Kettle itself is free, and anyone, including you, can contribute by wrapping some idiosyncratic series of transforms in a plugin, further reducing the overhead of implementing something similar elsewhere; however, it also means that the documentation straight-up sucks. Aside from the official literature (which seems to be in two separate but identical places for no readily apparent reason, and is not always wonderfully helpful either way), I am most definitely not the first to write about Kettle on the internet, but you have about as much of a chance to find something usefully relevant through Google as you have to find anything else. (This is the reason why this guide has such a narrow scope.)</li>
</ul>

<p>So, with no further ado...</p>

<h2>
<a id="user-content-a-simple-kettle-transform" class="anchor" href="#a-simple-kettle-transform" aria-hidden="true"><span class="octicon octicon-link"></span></a>A simple Kettle transform</h2>

<h3>
<a id="user-content-setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h3>

<p>I'm going to mostly gloss over the process of installing Kettle, for the simple reason that it doesn't actually need installation: you just download it, unzip it, and provided your JRE is up to date it should work straight out of the box. You just run the appropriate batch file/shell script, and you're off to the races. In the first instance, that'll be <code>Spoon</code>, the GUI in which you'll be doing the lion's share of your developing.</p>

<p>One thing you should note, though, is that it requires a few environment variables:</p>

<p><a href="./tut_img/1.png" target="_blank"><img src="./tut_img/1.png" alt="Starting Spoon from the command line" style="max-width:100%;"></a></p>

<p>As far as I know, the only one Spoon needs to work is <code>JAVA_HOME</code> (though it will complain at you if the others aren't set), but if I recall correctly Pan and Kitchen (command-line tools we'll be seeing later) need the other two, so you might as well set them and forget about them.</p>

<blockquote>
<p>If you're on a High DPI device, you might also want to look up how to make Kettle use an external manifest file to recognize that, so that the GUI elements are big enough to see and use without squinting. I didn't do this, because I don't actually use the buttons, and everything else is just big enough to not be annoying, but YMMV.</p>
</blockquote>

<p>If this is all sorted out, Spoon should fire up:</p>

<p><a href="./tut_img/2.png" target="_blank"><img src="./tut_img/2.png" alt="First look at Spoon" style="max-width:100%;"></a></p>

<h3>
<a id="user-content-initial-requirements" class="anchor" href="#initial-requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initial requirements</h3>

<p>For simplicity, let's say your requirements are in the form of (appropriately mad-libbed) statements that your stakeholders want to see in the LRS:</p>

<p><code>Student S took action A versus object O [at time T] [in context C] [with result R]</code></p>

<p>This is the format I found most useful, because it reflects the xAPI philosophy of allowing form to follow content rather than vice versa, and makes clear <em>what</em> you should be delivering but leaves the <em>how</em> up to you, but YMMV here. </p>

<p>Let's also say that your stakeholders are doing some very simple analytics based on how often students login to Blackboard. The only kind of statement they want to see is:</p>

<p><code>Student S logged into Blackboard at time T</code></p>

<blockquote>
<p><strong>A note on unit testing</strong></p>

<p>I would have enjoyed writing this guide in a more test-driven style, but unit testing Kettle transforms is technically impossible because of what a transform is and how it works. This is detailed in a series of posts starting <a href="http://www.mooreds.com/wordpress/archives/995">here</a> (and a forum post <a href="http://forums.pentaho.com/showthread.php?78217-Does-Kette-has-a-Unit-Testing-Framewok-for-ETL-like-JUnit-for-Java">here</a> where the main Kettle guy essentially says "no, you can't really do this"). It's possible to approximate proper unit tests, but this is essentially just a higher-level transform that can't be meaningfully automated, subject to the same chance of human error in its design. So, while the above article's statement that tests are "twice the work" is false for a purely cognitive definition of "work", the lack of meaningful automation means that you do spend twice the time, and the fact that there's no programmatic test suite to logically preclude some human error means (according to my intuitive and probably fallacious grasp of the math) that the average number of bugs goes from <em>n</em> to <em>n</em>². I tried to write declaratively, at least, so you can imagine the unit tests... in your mind, man. If you want to follow the above articles and develop unit tests for all your transforms, more power to you.</p>
</blockquote>

<h4>
<a id="user-content-step-1-extract" class="anchor" href="#step-1-extract" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 1: Extract</h4>

<p>Kettle calls the files you design in Spoon <em>transformations</em> (which I've been calling transforms for short); the first thing to do, then, is to create one, and to make sure you can get records from the DB with the information you need.</p>

<p><a href="./tut_img/3.png" target="_blank"><img src="./tut_img/3.png" alt="Create a new transformation" style="max-width:100%;"></a></p>

<p>Next, drag a <em>Table input</em> step from the sidebar to the workspace. (You can filter the available steps by entering text in the box.)</p>

<blockquote>
<p>To actually write the SQL, I prefer not to use Spoon; if you just want to know if a query will run and return useful data, you don't need to know what happens to the data after that, so there's no reason to run a partially-complete transform. You <em>can</em>, of course, but there's a lot of overhead that I feel slows me down. I like how you can hit <code>Ctrl+Enter</code> to run a single statement in SQL Developer, but you can also write scripts in your favorite text editor and execute them from the command line. Whatever works.</p>
</blockquote>

<p><a href="./tut_img/4.png" target="_blank"><img src="./tut_img/4.png" alt="Table input" style="max-width:100%;"></a></p>

<p>Above, I said "records with the information you need"; this seems trivially obvious, but I mean it in a way that may not be. (It wasn't to me at first.) Kettle works on <em>rows</em> - that is to say, the fundamental, indivisible unit of data is a single record which is understood to consist of fields. (You can conceptually divide a row into any number of groups of its constituent fields, but if you did this literally in Kettle, what you would have would be new, separate rows with fields that happen to correspond to some degree with the input row.)</p>

<p>What this means is that before you can operate on two items of data as though they were related, you have to make them actually related by making them part of the same row. Kettle only ever "sees" a single row at a time (with the exception of things like <em>Analytic query</em> and <em>Group by</em> steps, which we don't need quite yet), so if you want to construct a statement that says </p>

<p><code>Student S logged into Blackboard at time T</code></p>

<p>then you need to get <code>S</code>, <code>T</code> and the datum that a login occurred, in a single row from your query result. As such, we know that the query has to look something like this:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
    user_id,
    <span class="pl-k">timestamp</span>
<span class="pl-k">from</span> ???
<span class="pl-k">where</span> event <span class="pl-k">like</span> <span class="pl-s"><span class="pl-pds">'</span>%login%<span class="pl-pds">'</span></span>
;</pre></div>

<p>Fortunately, as you may or may not be aware, there's a table in Blackboard that gives us most of this:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
<span class="pl-c">--  user_id,</span>
    <span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa
<span class="pl-k">where</span> event <span class="pl-k">like</span> <span class="pl-s"><span class="pl-pds">'</span>%login%<span class="pl-pds">'</span></span>
;</pre></div>

<blockquote>
<p>The particulars of accessing any given table may differ in your environment; at any rate, <code>activity_accumulator</code> falls under the <code>as_core</code> schema.</p>
</blockquote>

<p>It still needs some work, though. We need to substitute <code>event_type</code> for <code>event</code>; however, there are ±7 different values that field might hold, of which the only relevant one is <code>LOGIN_ATTEMPT</code> (which gives us successful as well as unsuccessful logins). So, we also need another filter to only get rows representing successful login events:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
<span class="pl-c">--  user_id,</span>
    <span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa
<span class="pl-k">where</span> <span class="pl-c1">aa</span>.<span class="pl-c1">event_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>LOGIN_ATTEMPT<span class="pl-pds">'</span></span>
<span class="pl-k">and</span> <span class="pl-c1">aa</span>.<span class="pl-c1">data</span> <span class="pl-k">like</span> <span class="pl-s"><span class="pl-pds">'</span>%Login succeeded%<span class="pl-pds">'</span></span>
;
<span class="pl-c">/* figuring out what other information aa.data can hold </span>
<span class="pl-c">is left as an exercise to the reader; this is how it looks</span>
<span class="pl-c">when someone logs in successfully */</span></pre></div>

<p><code>user_id</code> is commented out because it's an invalid identifier for <code>activity_accumulator</code>; to make it work, we'll need a join with <code>users</code>.</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
    <span class="pl-c1">u</span>.<span class="pl-c1">user_id</span>,
    <span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa

<span class="pl-k">left join</span> (
    <span class="pl-k">select</span>
        pk1,
        user_id
    <span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">users</span>
) u
<span class="pl-k">on</span> <span class="pl-c1">aa</span>.<span class="pl-c1">user_pk1</span> <span class="pl-k">=</span> <span class="pl-c1">u</span>.<span class="pl-c1">pk1</span>

<span class="pl-k">where</span> <span class="pl-c1">aa</span>.<span class="pl-c1">event_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>LOGIN_ATTEMPT<span class="pl-pds">'</span></span>
<span class="pl-k">and</span> <span class="pl-c1">aa</span>.<span class="pl-c1">data</span> <span class="pl-k">like</span> <span class="pl-s"><span class="pl-pds">'</span>%Login succeeded%<span class="pl-pds">'</span></span>
;</pre></div>

<blockquote>
<p>I got used to doing my joins this way while learning SQL because it seemed wasteful to make the DB return the whole row if all I wanted was a couple of fields; however I never actually noticed any difference in performance and it probably takes about the same amount of time even in theory if the tables are indexed. IANADBA, YMMV.</p>
</blockquote>

<p>If you try running this you should notice that you also get a bunch of rows corresponding to instructor and administrator logins. That's no good - the target statement is <code>Student S logged in</code>. So, add another filter, and a join to return the data it filters on:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
    <span class="pl-c1">u</span>.<span class="pl-c1">user_id</span>,
    <span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa

<span class="pl-k">left join</span> (
    <span class="pl-k">select</span>
        <span class="pl-c1">iu</span>.<span class="pl-c1">pk1</span>,
        <span class="pl-c1">iu</span>.<span class="pl-c1">user_id</span>,
        <span class="pl-c1">ir</span>.<span class="pl-c1">name</span> <span class="pl-k">as</span> role
    <span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">users</span> iu
    <span class="pl-k">left join</span> (
        <span class="pl-k">select</span>
            pk1,
            regexp_substr(role_name,<span class="pl-s"><span class="pl-pds">'</span>[^<span class="pl-cce">\.</span>]+<span class="pl-pds">'</span></span>) <span class="pl-k">as</span> name
            <span class="pl-c">/* this regexp is because the value of this field is sometimes</span>
<span class="pl-c">            given as a stringified Java property: 'role.name' where we're</span>
<span class="pl-c">            only interested in 'role' */</span>
        <span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">institution_roles</span>
    ) ir
    <span class="pl-k">on</span> <span class="pl-c1">iu</span>.<span class="pl-c1">institution_roles_pk1</span> <span class="pl-k">=</span> <span class="pl-c1">ir</span>.<span class="pl-c1">pk1</span>
) u
<span class="pl-k">on</span> <span class="pl-c1">aa</span>.<span class="pl-c1">user_pk1</span> <span class="pl-k">=</span> <span class="pl-c1">u</span>.<span class="pl-c1">pk1</span>

<span class="pl-k">where</span> <span class="pl-c1">aa</span>.<span class="pl-c1">event_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>LOGIN_ATTEMPT<span class="pl-pds">'</span></span>
<span class="pl-k">and</span> <span class="pl-c1">aa</span>.<span class="pl-c1">data</span> <span class="pl-k">like</span> <span class="pl-s"><span class="pl-pds">'</span>%Login succeeded%<span class="pl-pds">'</span></span>
<span class="pl-k">and</span> regexp_like(<span class="pl-c1">u</span>.<span class="pl-c1">role</span>,<span class="pl-s"><span class="pl-pds">'</span>student<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>i<span class="pl-pds">'</span></span>)
;</pre></div>

<blockquote>
<p>More SQL idiosyncrasy: I prefer to scope my joins to where they're relevant, so <code>institution_roles</code> gets joined to <code>users</code> rather than <code>activity_accumulator</code> because it's related to the user-identifying part of the row rather than the activity or the row itself. Seeing where things come from helps me keep it all right-side-up in my head, but the query would still work if it was rewritten to be flatter. As always, YMMV.</p>

<p>Also, I'm using regexps here because in my environment, there are a number of records in the <code>institution_roles</code> table for which the <code>role_id</code> is not specific enough and the <code>role_name</code> is too descriptive. They all include the word "student", though, so I want the rows that match that case-insensitively (the third argument to <code>regexp_like()</code> is a mode string like you'd find on a "canonical" regexp). This is just defensive design, in case someone starts using different roles or more are added to the DB. Alternatively, if that's unlikely, you could replace <code>regexp_like()</code> with a straightforward <code>u.role in (role1, role2, ...)</code> - whatever works. </p>
</blockquote>

<p>Your query should now be sufficiently rigorous; open the <em>Table input</em> step configuration in Spoon by double-clicking it and copy-paste the SQL in. <strong>IMPORTANT: Kettle doesn't expect more than one SQL statement per <em>Table input</em> step, so it'll choke on the terminating semicolon if you don't remove it.</strong> This is also a good time to give the step a more descriptive name.</p>

<p><a href="./tut_img/5.png" target="_blank"><img src="./tut_img/5.png" alt="Filling in the finished query" style="max-width:100%;"></a></p>

<p>If you try to press "OK" now, Kettle will complain that you haven't selected a database connection. You can either create one of these by right-clicking the appropriate sidebar item and selecting "New", or by clicking the "New..." button in the <em>Table input</em> step. They both lead to the same dialog:</p>

<p><a href="./tut_img/6.png" target="_blank"><img src="./tut_img/6.png" alt="New database connection" style="max-width:100%;"></a></p>

<p>Fill in your details and credentials here. One stumbling block I encountered here (with which the docs were unhelpful) was that "Database name" is straight-up mislabeled and actually refers to the database <em>instance</em> name, which you should be able to find in the Blackboard frontend admin console. </p>

<blockquote>
<p>If you're developing at the University of Amsterdam, you probably have access to the transforms I already wrote, so save yourself a lot of institutional headache: make a copy of a transform that uses a DB connection and delete all the steps, then save that somewhere under a different name. The underlying XML should still contain the connection information for dev and production DBs, which you can use in <em>Table input</em> steps as described above.</p>
</blockquote>

<h4>
<a id="user-content-step-2-transform" class="anchor" href="#step-2-transform" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 2: Transform</h4>

<p>Now that we're receiving the correct rows from the DB, the next step is to generate a well-formed xAPI statement around them. I chose to use JavaScript for this; it could have been done a couple of other ways (the <em>Json output</em> step springs to mind, since you will eventually be POSTing JSON data to the LRS) but I prefer to have precise control over my JSON without interposing a bunch of interface layers.</p>

<p>Kettle does a fair bit of work for you under the hood; for instance, if you drag a <em>Modified Java Script Value</em> step to the workspace... </p>

<p><a href="./tut_img/7.png" target="_blank"><img src="./tut_img/7.png" alt="Add some logic" style="max-width:100%;"></a></p>

<p>...link it with the finished query step (shift-click on <em>query db for logins</em> and drag to the new step - the Kettle term for the resulting link is a "hop")...</p>

<p><a href="./tut_img/8.png" target="_blank"><img src="./tut_img/8.png" alt="Link up" style="max-width:100%;"></a></p>

<p>...and open it up for configuration, you should see "Getting fields...please wait" in the left sidebar under "Input fields" for a moment before the fields appear from the query we just designed, as Kettle runs the query to make sure it's valid and to decide what fields to show you.</p>

<p><a href="./tut_img/9.png" target="_blank"><img src="./tut_img/9.png" alt="Link complete" style="max-width:100%;"></a></p>

<blockquote>
<p>Incidentally, "Modified Java Script Step" is also a misnomer at this point. Presumably there was once a different kind of JavaScript step, and they presumably existed side-by-side for a while, but now there's just this one, so "modified" is misleading - it's just JS. It also doesn't return a single value; it returns as many as you like, as new fields on the rows that pass through it. UI is not Kettle's strong suit.</p>
</blockquote>

<p>xAPI statements are just JSON strings, so the main part of any step that turns a row into a statement is essentially going to be one big concatenation. When designing more complex transforms including JS steps that generate more than one type of statement, you'll need to include a little logic, but our requirements are simple enough that we don't need to do that here.</p>

<p>This is the part where agreements made with your stakeholders come into play; the LRS, by design, doesn't much care what content you give it, as long as the content is formatted correctly. So, if you want your data to be consistent both internally and with stakeholders' expectations, you should agree with them on a recipe/namespace/IRI schema for the statements you'll be generating. Let's say you agree that your statements should:</p>

<ul>
<li>use the <code>account</code> object as the inverse functional identifier (IFI) for the <code>actor</code> property</li>
<li>use the standard <code>activityType</code> and <code>verb</code> IRIs as listed on the <a href="https://registry.tincanapi.com/">xAPI/Tin Can Registry</a>
</li>
<li>include a <code>context</code> specifying that the action took place on Blackboard</li>
</ul>

<p>You might end up with JSON looking something like this:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>actor<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>objectType<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Agent<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>account<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>homePage<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>https://secure.uva.nl/<span class="pl-pds">"</span></span>,
            <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>whoever<span class="pl-pds">"</span></span>
        }
    },
    <span class="pl-s"><span class="pl-pds">"</span>verb<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>https://brindlewaye.com/xAPITerms/verbs/loggedin/<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>display<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>logged in<span class="pl-pds">"</span></span>
        }
    },
    <span class="pl-s"><span class="pl-pds">"</span>object<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>objectType<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Activity<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>definition<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>name<span class="pl-pds">"</span></span>: {
                <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Blackboard Learn<span class="pl-pds">"</span></span>
            },
            <span class="pl-s"><span class="pl-pds">"</span>type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>http://id.tincanapi.com/activitytype/lms<span class="pl-pds">"</span></span>
        }
    },
    <span class="pl-s"><span class="pl-pds">"</span>context<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>platform<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>
    },
    <span class="pl-s"><span class="pl-pds">"</span>timestamp<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>whenever<span class="pl-pds">"</span></span>
}</pre></div>

<blockquote>
<p>n.b.: all of this (and more) is documented - rather better than Kettle, not that that's hard - in the <a href="https://github.com/adlnet/xAPI-Spec/blob/master/xAPI.md">xAPI specification</a>.</p>
</blockquote>

<p>Obviously, we need to replace "whoever" and "whenever" with the fields from the DB query. This can be done in one of two ways; when I started developing Kettle transforms, the JavaScript JSON library hadn't been included with the engine that Kettle uses to run the JavaScript we're about to feed it (or at least that's my best guess at why it didn't work when I tried to use it), so I ended up having to literally concatenate the fields into the statement like so:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> statement <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>{\</span>
<span class="pl-s">//  ...  \</span>
<span class="pl-s">    "timestamp": "<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-c1">TIMESTAMP</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span>"\</span>
<span class="pl-s">}<span class="pl-pds">'</span></span>;</pre></div>

<p>That is, you assign a string literal (so that you can use quotes with impunity), cut a hole in it right between the quotes around the value of the property you're inserting, and concat the DB field as it's listed under "Input fields". (With liberal application of backslashes to keep everything readable, of course.) These are case-sensitive; if you double-click the name on the left, it'll insert it into your script at the cursor.</p>

<p>In the meantime, though, the JSON interface has been included, so instead we're doing this:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// because of how Kettle implements rows and fields as objects,</span>
<span class="pl-c">// you have to explicitly coerce input fields to strings before assigning</span>
<span class="pl-c">// or you'll get a Java error that the field doesn't have a method "toJSON()"</span>
<span class="pl-k">var</span> data <span class="pl-k">=</span> <span class="pl-smi">JSON</span>.<span class="pl-en">stringify</span>({
    actor<span class="pl-k">:</span> {
        objectType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Agent<span class="pl-pds">"</span></span>,
        account<span class="pl-k">:</span> {
            homePage<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://secure.uva.nl/<span class="pl-pds">"</span></span>,
            name<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">String</span>(<span class="pl-c1">USER_ID</span>)
        }
    },
    verb<span class="pl-k">:</span> {
        id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://brindlewaye.com/xAPITerms/verbs/loggedin/<span class="pl-pds">"</span></span>,
        display<span class="pl-k">:</span> {
            <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>logged in<span class="pl-pds">"</span></span>
        }
    },
    object<span class="pl-k">:</span> {
        objectType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Activity<span class="pl-pds">"</span></span>,
        id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>,
        definition<span class="pl-k">:</span> {
            name<span class="pl-k">:</span> {
                <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Blackboard Learn<span class="pl-pds">"</span></span>
            },
            type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>http://id.tincanapi.com/activitytype/lms<span class="pl-pds">"</span></span>
        }
    },
    context<span class="pl-k">:</span> {
        platform<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>
    },
    timestamp<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">String</span>(<span class="pl-c1">TIMESTAMP</span>)
});</pre></div>

<blockquote>
<p>There's arguably an even better way to do it. The <em>Modified Java Script Value</em> step lets you add multiple script tabs; you have to designate one of them as the "Transform script" (meaning it gets executed once per row, with the data from that row), and you can designate others as the Start script and End script, which get executed only once for every run of the whole transformation. This means you can initialize the barebones statement object in the Start script, then fill in the blanks and stringify it in the Transform script. Like so:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// Start script</span>

<span class="pl-k">var</span> skeleton <span class="pl-k">=</span> {
  actor<span class="pl-k">:</span> {
      objectType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Agent<span class="pl-pds">"</span></span>,
      account<span class="pl-k">:</span> {
          homePage<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://secure.uva.nl/<span class="pl-pds">"</span></span>,
          name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
      }
  },
  verb<span class="pl-k">:</span> {
      id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://brindlewaye.com/xAPITerms/verbs/loggedin/<span class="pl-pds">"</span></span>,
      display<span class="pl-k">:</span> {
          <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>logged in<span class="pl-pds">"</span></span>
      }
  },
  object<span class="pl-k">:</span> {
      objectType<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Activity<span class="pl-pds">"</span></span>,
      id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>,
      definition<span class="pl-k">:</span> {
          name<span class="pl-k">:</span> {
              <span class="pl-s"><span class="pl-pds">"</span>en-US<span class="pl-pds">"</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>Blackboard Learn<span class="pl-pds">"</span></span>
          },
          type<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>http://id.tincanapi.com/activitytype/lms<span class="pl-pds">"</span></span>
      }
  },
  context<span class="pl-k">:</span> {
      platform<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>https://blackboard.uva.nl/<span class="pl-pds">"</span></span>
  },
  timestamp<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
};

<span class="pl-c">// later assignments shouldn't affect the skeleton:</span>
<span class="pl-k">function</span> <span class="pl-en">clone</span> (<span class="pl-smi">obj</span>){
  <span class="pl-k">return</span> <span class="pl-smi">JSON</span>.<span class="pl-c1">parse</span>(<span class="pl-smi">JSON</span>.<span class="pl-en">stringify</span>(obj));
}

<span class="pl-c">// Transform script</span>

<span class="pl-c">// clone the skeleton</span>
<span class="pl-k">var</span> statement <span class="pl-k">=</span> <span class="pl-en">clone</span>(skeleton);

<span class="pl-c">// mad libs</span>
<span class="pl-smi">statement</span>.<span class="pl-smi">actor</span>.<span class="pl-smi">account</span>.<span class="pl-c1">name</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">String</span>(<span class="pl-c1">USER_ID</span>);
<span class="pl-smi">statement</span>.<span class="pl-smi">timestamp</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">String</span>(<span class="pl-c1">TIMESTAMP</span>);

<span class="pl-c">// ready to send</span>
<span class="pl-k">var</span> data <span class="pl-k">=</span> <span class="pl-smi">JSON</span>.<span class="pl-en">stringify</span>(statement);
</pre></div>

<p>This may have some performance costs, which may or may not be worth it considering the additional encapsulation and maintainability. YMMV.</p>
</blockquote>

<p>So now that the code is sorted, we want to make sure the step is sending the correct output (in this case, the finished statement as a JSON string). That's what the table at the bottom of the step configuration dialog is for: click "Get Variables" and it'll populate itself with all the variables you declared in the currently selected script tab. (It occasionally gets the type wrong, but you can change that manually. You don't even have to use "Get Variables"; just don't typo when entering the variable name you want to pass as an output field.)</p>

<p><a href="./tut_img/10.png" target="_blank"><img src="./tut_img/10.png" alt="Get variables" style="max-width:100%;"></a></p>

<p>Obviously, we don't need <code>statement</code> in there, so click its row number to select the whole row, delete it, and click "OK" to return to the workspace (after giving the new step an appropriate name as well). If you right-click on the JS step and select "Show output fields" you'll see that in addition to the field you told it to output, it's also passing through all the fields from the previous step. This isn't a disaster, but it's something to be aware of, especially since:</p>

<ul>
<li>a step which tries to add a field to a row that already has one with the same name will automatically (and silently) change the name to <code>field_n</code> (where <code>field</code> is the name and <code>n</code> is how many fields of that name the row already has)</li>
<li>it's not always clear or intuitive which steps pass through everything and which don't.</li>
</ul>

<p>This can result in subtle and annoying bugs if you don't expect it. If you need explicit control over which steps get passed, though, you can use a <em>Select values</em> step, which gives you exactly that.</p>

<h4>
<a id="user-content-step-3-load" class="anchor" href="#step-3-load" aria-hidden="true"><span class="octicon octicon-link"></span></a>Step 3: Load</h4>

<p>We're almost done with a basic transform - the last part is to send our finished statement to an LRS. Since it's just a REST service, you'll need a <em>REST Client</em> step:</p>

<p><a href="./tut_img/11.png" target="_blank"><img src="./tut_img/11.png" alt="REST client" style="max-width:100%;"></a></p>

<p>This one doesn't involve any code, it's just a dialog box with various configurable options. </p>

<p><a href="./tut_img/12.png" target="_blank"><img src="./tut_img/12.png" alt="REST config" style="max-width:100%;"></a></p>

<p>Things to pay attention to:</p>

<ul>
<li>General tab:

<ul>
<li>URL: Here, I'm using a local instance of the Apereo Learning Analytics Initiative LRS, Larissa, for development purposes (and so I didn't have to keep bugging the guy who coded it). You can find the GitHub for Larissa, with a readme detailing how to build and deploy, <a href="https://github.com/Apereo-Learning-Analytics-Initiative/Larissa">here</a>. Alternatively, you may have a dev LRS set up somewhere. </li>
<li>Method: POST.</li>
<li>Body field: make sure you select the correct one from the drop-down menu.</li>
<li>Application type: JSON.</li>
<li>Result field name: can be whatever you like.</li>
</ul>
</li>
<li>Authentication tab:

<ul>
<li>Login/password: whatever your LRS is configured to accept - instructions on adding users are also in the above readme.</li>
</ul>
</li>
<li>
<p>Headers tab: if you're familiar with the xAPI spec, you'll know that you have to pass an <code>X-Experience-API-Version</code> header with any HTTP request to an LRS; for some stupid reason, however, you can't set HTTP headers (or parameters) declaratively in Kettle; you have to pass them to the <em>REST Client</em> step as fields. It doesn't matter where they come from; that is, you can either do this:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
  <span class="pl-s"><span class="pl-pds">'</span>1.0.1<span class="pl-pds">'</span></span> <span class="pl-k">as</span> xapi_version,
  <span class="pl-c">-- ...</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa
<span class="pl-c">-- ...</span></pre></div>

<p>or you can do this:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// ...</span>
<span class="pl-k">var</span> data <span class="pl-k">=</span> <span class="pl-smi">JSON</span>.<span class="pl-en">stringify</span>(statement);
<span class="pl-k">var</span> xApiVersion <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>1.0.1<span class="pl-pds">'</span></span>;</pre></div>

<p>I put it in the JavaScript step, for the same reason that I scope my SQL joins (that is, the version is relevant to the processing of the statement, which only gets produced in the JavaScript step), but YMMV as always. Whichever way you do it: the input field you select from the drop-down box in the Headers tab becomes the header value, and the table cell next to it becomes the header name.</p>

<p><a href="./tut_img/13.png" target="_blank"><img src="./tut_img/13.png" alt="Headers tab" style="max-width:100%;"></a></p>
</li>
</ul>

<h3>
<a id="user-content-vitamins-done-requirements-implemented-what-now" class="anchor" href="#vitamins-done-requirements-implemented-what-now" aria-hidden="true"><span class="octicon octicon-link"></span></a><del><a href="https://youtu.be/C2s0aOhkjmY?t=101">Vitamins done</a></del> Requirements implemented, what now?</h3>

<p>Technically, the transform is finished now - you can run it and it'll function. It could still use a little work, though. For one thing, you'll want to know if you configured everything correctly; also, you're getting all the login events from Blackboard, while maybe some students didn't consent to you extracting that data. </p>

<h4>
<a id="user-content-logging" class="anchor" href="#logging" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logging</h4>

<p>This one is pretty simple: all you need is a <em>Write to log</em> step.</p>

<p><a href="./tut_img/14.png" target="_blank"><img src="./tut_img/14.png" alt="Logging" style="max-width:100%;"></a></p>

<p>This step is also useful for debugging purposes, but it has a caveat: it doesn't just automatically log whatever fields it's passed. If you have a step that's passing rows with, say, <code>field_x</code> and <code>field_y</code>, and you hook it up to a <em>Write to log</em> step, you have to open said step and click "Get Fields" so that it can see what options it has to choose from (which you can then trim if, for instance, you don't want to see <code>field_x</code>). If, later, you add <code>field_z</code> to the rows passed to <em>Write to log</em>, it (perhaps obviously) won't log that until you "Get Fields" again, but even more annoyingly, if you instead <em>change</em> <code>field_x</code> to <code>field_z</code> in the input it'll actually fail with an error because the <em>Write to log</em> step no longer sees the <code>field_x</code> it's expecting.</p>

<h4>
<a id="user-content-consent" class="anchor" href="#consent" aria-hidden="true"><span class="octicon octicon-link"></span></a>Consent</h4>

<p>This one is slightly trickier. You have a list of students whose data you're allowed to extract, but you probably got it directly from your stakeholders - there's not guaranteed to be a way to get that same list out of Blackboard programmatically. (And if there is, it's probably going to make your query <em>much</em> hairier.) So, you need to make Kettle read whatever input you might want to give it.</p>

<p>Unfortunately this isn't quite as easy as in <code>your favorite programming language here</code>, but it can still be done with a modicum of effort. Though you can pass arbitrary strings (including filenames) as arguments to a Kettle transform via the command line, there's no way to read a file directly into a step based on command-line input. So, we'll have to get the argument from the process first and read from the file based on that.</p>

<p>The first thing you'll need is a text file with the consenting students' IDs. This can be formatted any way you like; for simplicity, though, I prefer a file with each ID on its own line, like so:</p>

<pre><code>student_id1
student_1d2
etc_etc_etc
student_idn
</code></pre>

<blockquote>
<p>Annoyingly, Kettle isn't quite smart enough to understand relative paths (which may have something to do with the fact that Kettle's CLI tools are just batch file/shell script wrappers around a .jar file that lives elsewhere), so you have to give it the full path of any filenames you want to pass in as arguments - including the filenames of the transforms you're running. Tab-completion makes this fairly quick on Linux; if you're on Windows, though, it's probably a total crock of shit, so here's a PowerShell script I bashed together/found somewhere (can't quite remember which): </p>

<div class="highlight highlight-source-powershell"><pre><span class="pl-k">function</span> <span class="pl-en">Full-Path</span>
{
  <span class="pl-k">param</span><span class="pl-k">(</span> <span class="pl-e">[string]</span><span class="pl-k">$</span><span class="pl-smi">Item</span> <span class="pl-k">)</span>
  <span class="pl-k">(</span><span class="pl-k">$</span><span class="pl-c1">pwd</span><span class="pl-en">.path</span><span class="pl-k">+</span><span class="pl-k">$</span><span class="pl-smi">Item</span><span class="pl-en">.substring</span><span class="pl-k">(</span><span class="pl-c1"><span class="pl-c1">1</span></span><span class="pl-k">)</span><span class="pl-k">)</span>
}</pre></div>

<p>Save this in your PowerShell folder, and then add the following lines to your PowerShell profile:</p>

<div class="highlight highlight-source-powershell"><pre><span class="pl-k">.</span> C:\Users\you\Documents\WindowsPowerShell\<span class="pl-c1">Full-Path.ps1</span>
<span class="pl-c1">Set-Alias</span> fp Full<span class="pl-k">-</span>Path</pre></div>

<p>Then re-start your shell and you should be able to get the full path of a file like so:</p>

<p><code>(fp .\a_file_that_lives_here.ext)</code> </p>
</blockquote>

<p>Once you have the text file, add these two steps to the transform:</p>

<p><a href="./tut_img/15.png" target="_blank"><img src="./tut_img/15.png" alt="Read command args" style="max-width:100%;"></a></p>

<p>Configuring <em>Get System Info</em> is straightforward; you just have to tell it what you want and what to call it:</p>

<p><a href="./tut_img/16.png" target="_blank"><img src="./tut_img/16.png" alt="Sysinfo config" style="max-width:100%;"></a></p>

<p>Configuring <em>Text file input</em> is slightly more annoying, though it helps to realize that Kettle still expects to see rows and fields in whatever file you read in.</p>

<p><a href="./tut_img/17.png" target="_blank"><img src="./tut_img/17.png" alt="File tab config" style="max-width:100%;"></a></p>

<p>The File tab is straightforward enough, though. Checking "Accept filenames from previous step" grays out the entire upper two-thirds of the dialog; there should only be one option in the "Step to read filenames from" drop-down box; the only moderately stupid thing is that you have to manually input the field name - there's no drop-down box here, or a button to automatically get the step's input fields. (Because it wouldn't be open-source if there weren't a few unnecessary chances for bugs to slip in, I guess.)</p>

<p>There are way many options to configure in this step, most of which you fortunately don't have to touch. Some things to pay attention to, though:</p>

<p><a href="./tut_img/18.png" target="_blank"><img src="./tut_img/18.png" alt="Content tab config" style="max-width:100%;"></a></p>

<ul>
<li>Kettle has lied to you again: the step is called <em>Text file input</em>, implying you can read in arbitrary text files, but actually the only two formats it accepts are CSV and fixed-width CSV. This means that while our list of student IDs will be parsed just fine, Kettle is actually treating it as a CSV file with only one field.</li>
<li>As such, you can leave the "Separator" option alone here; it doesn't matter what it is, as Kettle will never see one.</li>
<li>You have to clear the "Enclosure" field, though. Alternatively, you could wrap each student ID in quotes, but that's unnecessary.</li>
<li>You also have to uncheck "Header". Again, you could also add a header to the file, but the goal here is to make it easy to change the inputs - if you were going to hardcode everything about this file, you could have just input the filename manually in the File tab. (I developed this habit because, as mentioned, I deployed to Linux - specifically, a server where I had no desktop, so the only way to change a transform in production was to edit the XML itself. Modularity is a Good Thing anyway, though.)</li>
<li>Everything else in this tab you can leave as-is. It shouldn't give you any trouble.</li>
</ul>

<p>The last thing you need to do is tell Kettle what you want to call the single field it's reading from your text file; "Get Fields" won't work here, because the pre-processing that determines the incoming field names doesn't include generating command-line arguments, so just input a name and a type in the Fields tab, click "OK", and connect the step to <em>query db for logins</em>:</p>

<p><a href="./tut_img/19.png" target="_blank"><img src="./tut_img/19.png" alt="Fields config" style="max-width:100%;"></a></p>

<p>Speaking of which: we'll have to edit that step if we want to make use of the ability to programmatically configure the query.</p>

<p><a href="./tut_img/20.png" target="_blank"><img src="./tut_img/20.png" alt="Edit query" style="max-width:100%;"></a></p>

<p>We're doing three things here:</p>

<ul>
<li>Selecting a step from the "Insert data from step" drop-down - it should show the recently connected <em>read user list</em> step.</li>
<li>Checking "Execute for each row" so that we process all the IDs in the file.</li>
<li>
<p>Adding a line to the query:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-c">-- ...</span>
<span class="pl-k">and</span> regexp_like(<span class="pl-c1">u</span>.<span class="pl-c1">role</span>,<span class="pl-s"><span class="pl-pds">'</span>student<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>i<span class="pl-pds">'</span></span>)
<span class="pl-k">and</span> <span class="pl-c1">u</span>.<span class="pl-c1">user_id</span> <span class="pl-k">=</span> ?</pre></div>

<p>If you've done the previous two things, adding a question mark where the DB expects to see a single term will make Kettle programmatically fill in the value from the appropriate step. This happens in top-to-bottom order at both ends: if you right-click the previous step and select "Show output fields" you should see a table with a certain order. This is the order that the <em>Table input</em> step will follow when filling in the blanks. It doesn't matter if a particular question mark is nested ten levels deep inside the query; if it's the first one Kettle comes across when reading the SQL top-to-bottom, it'll receive the value of the first field in each incoming row. (This doesn't matter now because we only have one field in the incoming row, but it's something to keep in mind.)</p>
</li>
</ul>

<blockquote>
<p>n.b.: "Replace variables in script" sounds like the above is what it does, but (surprise, surprise) it actually does something slightly different: it allows you to use variables defined elsewhere (including other transformations, which we'll be writing later on).</p>
</blockquote>

<h4>
<a id="user-content-deploying" class="anchor" href="#deploying" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploying</h4>

<p>So, the transform is finished; it implements the necessary functional requirements and it's configurable for a variable list of consenting participants. Time to run it. Make sure to save your transform, then start a terminal and navigate to the folder where you keep it. </p>

<p>The command-line tool to run a single transform is called Pan. On Linux the appropriate shell script is <code>pan.sh</code>; on Windows it's the batch file <code>Pan.bat</code>. I added the Kettle directory to my <code>PATH</code>, but you can also run it by name; whatever works. </p>

<p>Either way, you'll need to set a few options before passing the name of your transform and the student list:</p>

<ul>
<li>
<code>norep</code> tells Kettle not to use a repository (which is a good idea because repositories are buggy and not well-maintained)</li>
<li>
<code>file</code> tells Kettle you want to pass in an XML file as the transformation to run.</li>
</ul>

<blockquote>
<p>There are several more options which you may find useful; invoke Pan with no arguments to see them.</p>
</blockquote>

<pre><code># Linux
$ sh ~/data-integration/pan.sh -norep -file /full/path/to/tf1.ktr /full/path/to/studentIDs.txt

# Windows
&gt; pan /norep /file (fp .\tf1.ktr) (fp .\studentIDs.txt)
</code></pre>

<p>Kettle will throw a lot of superfluous boilerplate log at you:</p>

<p><a href="./tut_img/21.png" target="_blank"><img src="./tut_img/21.png" alt="Pan logs" style="max-width:100%;"></a></p>

<p>You generally only have to start paying attention when the <em>Write to log</em> step starts talking; in any case, though, this is the part where you start getting errors if things are configured incorrectly. For instance, the first time I ran this I got a JSON error from the LRS (which is helpfully sent back as the HTTP response, and therefore logged by Kettle as the value of the <code>response</code> field in <em>Write to log</em>) because I forgot to camel-case "homePage" in the statement skeleton object.</p>

<p>Once I fixed that, I started getting a different JSON error (so if you're following along then you should be getting it as well); the format of a timestamp stringified exactly as the DB supplies it is apparently not one the LRS is prepared to accept:</p>

<p><a href="./tut_img/22.png" target="_blank"><img src="./tut_img/22.png" alt="Bad timestamp" style="max-width:100%;"></a></p>

<p>There are, as usual by this point, several ways you can fix this; I prefer to take care of it in the DB query, for reasons you can probably guess by now. You'll find, though, that every dialect of SQL has its own pecularities as regards datetime format elements; a quick dip into the <a href="https://docs.oracle.com/cd/B28359_01/server.111/b28286/sql_elements004.htm#i34924">Oracle docs</a> reveals that if this is the format expected by the LRS (and I picked this one because it's ISO8601-compliant, which is never a bad idea):</p>

<div class="highlight highlight-source-json"><pre><span class="pl-s"><span class="pl-pds">"</span>yyyy-MM-dd'T'HH:mm:ss.SSS'Z'<span class="pl-pds">"</span></span></pre></div>

<p>Then this is the change I have to make to the query:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">select</span>
    <span class="pl-c1">u</span>.<span class="pl-c1">user_id</span>,
    to_char(<span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span>,<span class="pl-s"><span class="pl-pds">'</span>YYYY-MM-DD"T"HH24:MI:SS".000Z"<span class="pl-pds">'</span></span>) <span class="pl-k">as</span> <span class="pl-k">timestamp</span>
    <span class="pl-c">/* yes, we're losing fractional seconds here; it should actually be</span>
<span class="pl-c">    '...:SS.FF3"Z"', but for some stupid reason our Oracle installation</span>
<span class="pl-c">    chokes on the FF[1-9] format element, despite it being documented</span>
<span class="pl-c">    quite clearly. ymmv. */</span>
<span class="pl-k">from</span> <span class="pl-c1">bb_bb60</span>.<span class="pl-c1">activity_accumulator</span> aa
<span class="pl-c">-- ...</span></pre></div>

<p>Run the transform again and all is well (the LRS sends the UUID of any statement it accepts as the response to the HTTP request which created that statement):</p>

<p><a href="./tut_img/23.png" target="_blank"><img src="./tut_img/23.png" alt="Good timestamp" style="max-width:100%;"></a></p>

<p>Hang on, though - if we schedule this transform to run regularly (say, once every day), it's going to send a lot of duplicate statements to the LRS (because there's no functionality to check what rows we've already seen, and indeed that's not possible to do in a single transform because - quite sensibly - identical rows generated by the same transform at different times will be parsed as logically different); because the LRS only cares about form and not about content, it'll accept them, analytics based on the LRS will go off the rails, and everyone will be pissed off. How do we make sure we're only sending statements we haven't already sent?</p>

<h3>
<a id="user-content-pre-dinner-mayonnaise-functional-flavor" class="anchor" href="#pre-dinner-mayonnaise-functional-flavor" aria-hidden="true"><span class="octicon octicon-link"></span></a><del><a href="https://youtu.be/3d-qENAaNbM?t=111">Pre-dinner mayonnaise</a></del> Functional flavor</h3>

<p>Conceptually, this isn't a particularly tricky requirement. We just need a timestamp after which we know for sure there aren't any of our statements in the LRS. However, there are several things that make this slightly less straightforward in practice:</p>

<ul>
<li>Obviously, we need to know the latest timestamp <em>before</em> we query the DB, because we have to add it as a filter on that query.  However: Kettle transforms, by design, don't guarantee that rows will pass through in any given order, so whatever we do, we can't be getting the latest timestamp in same transform that uses it.</li>
<li>Additionally, xAPI is an open standard, and it would be obstructively naïve to imagine that we're developing the only application that'll ever be storing statements in the LRS; as such, we don't just need the timestamp of the most recent statement in the LRS: we need the timestamp of the most recent statement <em>that we know we sent</em>.</li>
<li>However, we can't actually ask the LRS itself what this timestamp is: the LRS runs on top of CouchDB, which is a document-based DB you interact with through a REST API. This means there are two ways to find a given document: either you include its ID directly in the HTTP query parameters, or you craft that query such that the document is included in the result set. The catch is that the set of documents you receive as a response to the latter query might not actually be identical with the set of all documents that match the query: before a document can be successfully queried for by anything other than its ID, CouchDB has to <em>index</em> it (generate a view that includes it). </li>
<li>This means that if you pump a metric shit-ton of documents into the LRS at once, and then ask for the timestamp of the most recent one before all of them have been indexed, you're not going to get the timestamp you expect; you're going to get the timestamp of the statement which the LRS' DB has most recently indexed. If you then use this timestamp as a boundary condition for the next batch of statements, you're going to get some degree of overlap in the periods of time covered by two subsequent batches, which (especially if you're sending a lot of volume to begin with) can result in a <em>lot</em> of duplicate statements, which is exactly what we're trying to avoid.</li>
<li>There are a variety of ways to solve this; what seems like the safest thing is to check beforehand if indexing is complete, and don't send any new statements if it's not. (Blackboard data will continue to be there, so it's not like you're failing to record activity if you're not constantly sending statements.) Fortunately, xAPI specifies a property for this. According to the spec, the <code>stored</code> property is the timestamp representing the point when the statement was "made available for retrieval"; since a statement logically has to be stored after it was received, all we need to do is record the timestamp of the latest POST request in every batch, and check to make sure the <code>stored</code> property of the most recently-indexed statement is later than that. (It's also possible to query CouchDB itself for a list of active tasks, including indexing, but that would generally either require us to be running our transforms on the same machine as the LRS or have it configured for remote administration, both of which are neither guaranteed nor even necessarily good ideas in this context.)</li>
<li>Finally, it's important to note that the timestamp of the latest POST request (which we need to check whether or not to run at all) is <em>not identical</em> with the timestamp of the statement sent as the body of that request (which we need, in the event we decide to run, to limit the result set of the database queries).</li>
</ul>

<h4>
<a id="user-content-keeping-order" class="anchor" href="#keeping-order" aria-hidden="true"><span class="octicon octicon-link"></span></a>Keeping order</h4>

<p>In any case, the decision to run or not obviously has to be made before running the transformation we just wrote. As mentioned, Kettle transforms don't have a fixed step order (the arrows just define where a row can go from any given step); Kettle <em>jobs</em>, though, most certainly do.</p>

<p>A job is one step up the scope/abstraction ladder; the main feature of a job is that you can run transforms from within it, and they're guaranteed to run in the order you specify, so there's an amount of certitude about the output of a particular job step (unhelpfully called a <em>job entry</em> in the docs even though they're isomorphic to transform steps) that you don't get in a transform. </p>

<p>So, the first thing to do is to write a transform that'll check whether or not it's safe to run, and after that we'll incorporate both transforms in a job (meaning we'll also have to modify the first transform to additionally record the data we need to make the above determination).</p>

<h4>
<a id="user-content-checking-indexing" class="anchor" href="#checking-indexing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Checking indexing</h4>

<p>Start with a new transform and a blank workspace; this time, though, I'll assume increasing facility with Kettle (and its barely-there docs), so that we can do some of the thinking ahead of time and in a nutshell with regard to which steps we'll need and why: </p>

<ul>
<li>We know we need two timestamps before we start running: the latest POST request made by the last-run instance of our main transform, and the latest activity recorded in a statement by that transform. There are probably more ways to do this than there are developers who could implement it, so let's pick a simple solution and stick with it: the main transform will append each of those to its own text file, so that the job can read the last lines of both as separate command-line arguments. This means our new transform will need the <em>Get System Info</em> step to parse one of those arguments.</li>
<li>We'll need the <em>REST Client</em> step to query the LRS and the <em>Json Input</em> step to parse its response.</li>
<li>To be able to compare the timestamp of the latest POST with the most-recently-stored statement, we'll need to combine them into a single row, so we'll need <em>Join Rows (cartesian product)</em>.</li>
<li>Importantly, though, the <em>Json Input</em> step can specify a datatype for the fields it parses, but a command-line argument has to be a string, so we'll also need a <em>Select values</em> step to make the fields logically comparable.</li>
<li>To actually perform the comparison, we need a <em>Filter rows</em> step; in Kettle-land, anything not an explicit failure is a success, so we need an <em>Abort</em> step at the very least (and let's also add a <em>Write to log</em> step for some visible confirmation that things are happening as we expect).</li>
</ul>

<p>We're also going to need the <em>Generate Rows</em> step, since the <em>REST Client</em> step needs some input that we can't declare in its configuration. The workspace should look like this:</p>

<p><a href="./tut_img/24.png" target="_blank"><img src="./tut_img/24.png" alt="Timestamp checker workspace" style="max-width:100%;"></a></p>

<p>You'll notice that you have a choice of output types when you go to connect <em>Filter rows</em> and the steps following it. This is pretty straightforward.</p>

<p>Configuration of <em>Generate Rows</em> is also not complicated:</p>

<p><a href="./tut_img/25.png" target="_blank"><img src="./tut_img/25.png" alt="Generate rows config" style="max-width:100%;"></a></p>

<p>We're just setting the value of the <code>X-Experience-API-Version</code> header the way the <em>REST Client</em> step receives it from the row-to-statement step in the main transform, and sending it once.</p>

<p>The <em>REST Client</em> step needs a little more talking about, although the "Authentication" and "Headers" tabs should look identical to the ones in the main transform:</p>

<p><a href="./tut_img/26.png" target="_blank"><img src="./tut_img/26.png" alt="REST client config" style="max-width:100%;"></a></p>

<p>You can't declare headers in the step config, but at least you can specify the whole query: the URL to which we're POSTing in the main transform is also the one we GET from, but we also need to append a query string or we'll just get the 500 most recent statements (which is the order in which the LRS returns them by default, so we don't have to specify that) and a URL to GET from if we want the next 500. As you can see, we're just telling the LRS we want a single statement.</p>

<blockquote>
<p>The options available when constructing a query are fully documented in the xAPI spec, in the section on the <a href="https://github.com/adlnet/xAPI-Spec/blob/master/xAPI.md#stmtapi">Statement API</a>.</p>
</blockquote>

<p>The "Content" tab of the <em>Json Input</em> step you can leave as-is; the "File" tab only requires that you specify the field with incoming JSON:</p>

<p><a href="./tut_img/27.png" target="_blank"><img src="./tut_img/27.png" alt="JSON config 1" style="max-width:100%;"></a></p>

<p>The "Fields" tab is almost entirely straightforward as well, except for the "Path" field; this uses <a href="http://goessner.net/articles/JsonPath/">JSONPath</a> syntax to parse the JSON it receives.</p>

<p><a href="./tut_img/28.png" target="_blank"><img src="./tut_img/28.png" alt="JSON config 2" style="max-width:100%;"></a></p>

<p>Here's a breakdown of the syntax we're using, in case it's not totally clear:</p>

<pre><code>$               .                   statements
-----------------------------------------------------------------------
^ root node     ^ one level down    ^ name of property (here, an array)

.                                                       
-----------------------------------------------------------------------
^ down again (reaches some specific array element/s)

*
-----------------------------------------------------------------------
^ every element at the current depth (ie. all statement objects)

.                                       stored
-----------------------------------------------------------------------
^ down again (reaches each statement)   ^ name of property
</code></pre>

<p>The <em>Get System Info</em> step is about as simple as it gets; give the field a name, and select "command line argument 3" from the list that appears when you click the "Type" field. (I used the second argument for the statement timestamp because that makes sense to me: it's both causally and logically prior to the POST request that sends it. YMMV. The first argument, of course, is still the list of consenting student IDs.) The <em>Select values</em> step is only slightly less straightforward; it's worth noting that you apparently have to tell the step to select a field in the "Select &amp; Alter" tab before you can change its type in the "Meta-data" tab. Also, make sure you use the correct date format anytime you're casting a string to a date or vice versa. (There's only one format being used in this entire tutorial, but that doesn't have to be the case.)</p>

<p><em>Join rows (cartesian product)</em> is also fairly simple. We just want to make sure both dates are part of a single row, so we can set the condition to "TRUE"; a thing to pay attention to, however, is the "Main step to read data from" option. This will wait for rows from the specified input step by caching ones from any other input step. We know that the parsing and casting of the command-line argument will happen essentially instantaneously, while we might have to wait a second or two for a response from the LRS, so set this to <em>parse json response</em>:</p>

<p><a href="./tut_img/29.png" target="_blank"><img src="./tut_img/29.png" alt="Join rows config" style="max-width:100%;"></a></p>

<p>Finally, make sure the filter condition is configured correctly: we want to continue if and only if the <code>stored</code> property on the statement we just received is later (ie. greater) than our last POST request.</p>

<p><a href="./tut_img/30.png" target="_blank"><img src="./tut_img/30.png" alt="Filter rows config" style="max-width:100%;"></a></p>

<p>(<em>Write to log</em> and <em>Abort</em> should be self-explanatory by this point.)</p>

<h4>
<a id="user-content-jobs-well-done" class="anchor" href="#jobs-well-done" aria-hidden="true"><span class="octicon octicon-link"></span></a>Jobs well done</h4>

<p><code>Ctrl+Shift+N</code> creates a new job, and the workspace looks identical to that of a transform; the only real difference is that the sidebar gives you different steps (sorry, "entries"). All you really need to know is here:</p>

<p><a href="./tut_img/31.png" target="_blank"><img src="./tut_img/31.png" alt="Job workspace" style="max-width:100%;"></a></p>

<p>You only need the <em>START</em> and <em>Transformation</em> entries, and when configuring the latter, all you need to do is enter the path to the transform in question. That little <code>&lt;$&gt;</code> symbol next to some configuration fields (which you have undoubtedly seen elsewhere) means that the value of a variable can be used for all or part of that field; select the field and hit <code>Ctrl+Space</code> to see which ones are available. Kettle predefines a few for you; in this case, we want <code>${Internal.Job.Filename.Directory}</code>, which does exactly what it says on the tin. (This means you'll have to keep the transforms in the same directory as the job; feel free to modify as you see fit, or even hardcode the paths, as long as the job knows exactly where to find the transforms.) One thing worth mentioning: you'll notice that the hop between the two transforms is green with a little check mark; this works similarly to the <em>Filter rows</em> step in that you can specify different output steps based on whether the result of a transform was success or failure. You can also click the symbol to cycle the hop between states: success, failure and a little lock symbol that means the next transform is run unconditionally.</p>

<p>Now that that's sorted, we have to modify the main transform, to accept an additional argument as a filter on the query, and to append both of the timestamps we need to separate text files.</p>

<h4>
<a id="user-content-finishing-touches" class="anchor" href="#finishing-touches" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finishing touches</h4>

<p>There are a number of small-but-significant things to be done here, some of which may not be immediately obvious:</p>

<ul>
<li>configure <em>get cmd arg</em> to also read the second command-line argument;</li>
<li>configure <em>read user list</em> to "Pass through fields from previous step";</li>
<li>
<p>add a line to <em>query db for logins</em>, casting the new field to an appropriate datatype and filtering on it:</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-c">-- ...</span>
<span class="pl-k">and</span> <span class="pl-c1">u</span>.<span class="pl-c1">user_id</span> <span class="pl-k">=</span> ?
<span class="pl-k">and</span> <span class="pl-c1">aa</span>.<span class="pl-c1">timestamp</span> <span class="pl-k">&gt;</span> to_date(?,<span class="pl-s"><span class="pl-pds">'</span>YYYY-MM-DD"T"HH24:MI:SS".000Z"<span class="pl-pds">'</span></span>)</pre></div>

<p><a href="./tut_img/32.png" target="_blank"><img src="./tut_img/32.png" alt="SQL edit" style="max-width:100%;"></a></p>
</li>
<li>
<p>because you're now getting a superfluous field from <em>read user list</em> (the filename of the user list in question), add a <em>Select values</em> in between <em>read user list</em> and <em>query db for logins</em>, to filter that out (and make sure the fields you do want are being passed through in the correct order, since that matters for the query's purposes). You can drag the step directly onto the hop and Kettle will ask you if you want to interpose it:</p>

<p><a href="./tut_img/33.png" target="_blank"><img src="./tut_img/33.png" alt="Select values" style="max-width:100%;"></a></p>
</li>
</ul>

<p>So that's the filter taken care of; however, while we can run the job by manually entering correctly-formatted datetime strings, it's not quite ready for deployment. Here's where it gets slightly more tricky (but only slightly):</p>

<ul>
<li>
<p>Add another <em>Select values</em> step, <em>after</em> the query step but as a separate output (as opposed to interposing it between that step and <em>login row to statement</em>), to filter out everything but the timestamp, and cast it back to a "Date" datatype (pay attention to the format mask, as this is once again Java string parsing and not case-smashing SQL). If you haven't configured the appropriate option when you try to create a hop from a step that already has an output step, Kettle will ask you to pick "Distribute" or "Copy" as the behavior of the step you're linking from with regard to the rows that leave it; we want "Copy", which is also the default once you tell Kettle to stop asking.</p>

<p><a href="./tut_img/34.png" target="_blank"><img src="./tut_img/34.png" alt="More value selection" style="max-width:100%;"></a></p>
</li>
<li>
<p>Add a <em>Memory Group by</em> step after that. This step is an aggregator, caching the fields you tell it to from all the rows it receives and performing some transformation on the whole group. The upper table contains fields that are passed through as-is, and the lower table contains fields on which some aggregation is done. These are exhaustive: similarly to <em>Select values</em>, if a field doesn't appear in either table, it doesn't appear in the output.</p>

<p><a href="./tut_img/35.png" target="_blank"><img src="./tut_img/35.png" alt="Memory Group by" style="max-width:100%;"></a></p>
</li>
<li><p>Add yet another <em>Select values</em>; if you didn't, Kettle would write the timestamp to disk in whichever format it damn well pleased, and since the query expects a string of a particular format, we want a little more control over the output than that. (You could also modify the query to expect whatever format Kettle uses by default, but I like my solution better. YMMV.)</p></li>
<li>Finally, add a <em>Text file output</em> step, append the string representing the latest timestamp to a file in the same directory as the parent job (you have to explicitly tell it to append rather than clobber, but it'll quietly create the file if it doesn't exist yet). Remember that Kettle thinks this is basically a CSV file, so make sure you also tell it not to use enclosures or a header.</li>
</ul>

<p>That's one timestamp; the other is essentially the same deal. You'll need another <em>Get System Info</em>, <em>Memory Group by</em>, <em>Select values</em> and <em>Text file output</em>; helpfully, when <em>Get System Info</em> isn't used purely as an input step, it appends its fields to rows passed through it, so you just have to copy the output of the REST call (ie. the response confirming the LRS has received a statement) to that step and select "system date (variable)" as the type of the new field. (You don't have to interpose a <em>Select values</em> between <em>Get System Info</em> and <em>Memory Group by</em> because the system date is already a sensible datatype.) When you're through, the workspace should look something like this:</p>

<p><a href="./tut_img/36.png" target="_blank"><img src="./tut_img/36.png" alt="All done" style="max-width:100%;"></a></p>

<h4>
<a id="user-content-redeploying" class="anchor" href="#redeploying" aria-hidden="true"><span class="octicon octicon-link"></span></a>(Re)Deploying</h4>

<p>Fortunately, Kettle is tool-agnostic when it comes to parsing command-line arguments; this means all you really have to do with the invocation is change <code>pan</code> to <code>kitchen</code>, and the name of the transform to the name of the overarching job.</p>

<pre><code>$ sh ~/data-integration/kitchen.sh -norep -file /full/path/to/job1.kjb \
/full/path/to/studentIDs.txt

&gt; kitchen /norep /file (fp .\job1.kjb) (fp .\studentIDs.txt)
</code></pre>

<p><strong>However.</strong> Here's the part where I get less than totally system-agnostic, as a matter of principle: the way I prefer to pass the appropriate timestamps to the job is like this:</p>

<pre><code>$ sh ~/data-integration/kitchen.sh -norep -file /full/path/to/job1.kjb \
/full/path/to/studentIDs.txt \ 
`tail -1 /path/to/latest_timestamps.txt` \
`tail -1 /path/to/latest_posts.txt`
</code></pre>

<p>You can do command substitution in essentially the same way on Windows (and in fact I'm using it to get the full paths of things), but there really should be something equivalent to <code>tail</code>. Someone has ported the GNU coreutils to Windows by now, or alternatively you could write a PowerShell script, but here we are either way. </p>

<p>And that's it! Drop the job, transforms, and list of consenting users on an arbitrary machine with an up-to-date JRE and Kettle installed (ie. downloaded, unpacked, environment variables set), and you can schedule it to run however often you like.</p>

<h3>
<a id="user-content-additional-resources" class="anchor" href="#additional-resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Additional resources</h3>

<p>These are deliberately more rough-and-ready than the document you've just read.</p>

<p><a href="./more/fixin_larissa.html">Fixing the LRS</a></p>

<p><a href="./more/kettle_notes.html">Notes on what I already did at UvA</a></p>
</article></body></html>